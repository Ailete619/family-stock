# 基本設計書

## 1. アーキテクチャ概要
- **プレゼンテーション層**: SwiftUI (StockListView, ShoppingListView, ReceiptListView, SettingsView, RootView)。
- **データ層**: SwiftData モデル (`StockItem`, `ShoppingListEntry`, `Receipt`, `ReceiptItem`, `PendingSync`)。
- **同期層**: `SyncService`（`ItemRepository`, `ShoppingListEntryRepository`, `ReceiptRepository` を束ねる）と `OfflineQueueService`。
- **外部サービス**: Supabase REST + Auth。
- **構成図 (テキスト)**:  
  ユーザー操作 → SwiftUI View → SwiftData ModelContext → (オンライン) SyncService → Supabase  
  ↓ (オフライン) OfflineQueueService / PendingSync → 後日再送

## 2. 画面構成
| 画面 | 役割 | 主な View / コンポーネント |
| --- | --- | --- |
| 認証画面 | Supabase ログイン・ローカルモード切替 | `AuthView` |
| 在庫リスト | 在庫一覧、数量変更、編集/削除、ショッピング追加 | `StockListView`, `StockListRow`, `StockItemSheet` |
| 買い物リスト | Shopping エントリ管理、完了フラグ、レシート保存 | `ShoppingListView`, `ShoppingListRow` |
| レシート一覧/詳細 | 購入履歴確認 | `ReceiptListView`, `ReceiptDetailView` |
| 設定 | 同期状態・ログアウト | `SettingsView` |

### 画面遷移概要
- アプリ起動 → `RootView`  
  - 認証済み: TabView（Stock/Shopping/Receipts/Settings）  
  - 未認証: `AuthView`
- 在庫追加時に `StockItemSheet` をシート表示。
- レシート保存は `ShoppingListView` からモーダルフォーム。

## 3. モジュール構成
| モジュール | 主責務 | 代表ファイル |
| --- | --- | --- |
| Stock | 在庫 UI / モデル / Mapper | `StockItem.swift`, `StockItem+Mapping.swift`, `StockItemSheet.swift`, `StockListView.swift`, `StockListRow.swift` |
| Shopping | 買い物 UI / モデル / Mapper | `ShoppingListEntry.swift`, `ShoppingListEntry+Mapping.swift`, `ShoppingListView.swift` |
| Receipts | レシート UI / モデル / Mapper | `Receipt.swift`, `Receipt+Mapping.swift`, `ReceiptListView.swift`, `ReceiptDetailView.swift`, `ReceiptItem.swift` |
| Network | リポジトリ・同期・HTTP | `SyncService.swift`, `OfflineQueueService.swift`, `ItemRepository.swift`, `ShoppingListEntryRepository.swift`, `ReceiptRepository.swift`, `PendingSync.swift` |
| Auth/Helpers | 認証状態、Secrets 管理、汎用ユーティリティ | `AuthView.swift`, `Secrets.plist`, `Helpers` ディレクトリ |
| Tests | ユニット/UITest | `FamilyStockTests`, `FamilyStockUITests` |

## 4. データモデル（概要）
- **StockItem**: 在庫基本情報。`@Model` と `@Attribute(.unique)` で ID 一意制約。
- **ShoppingListEntry**: `itemId` FK と desiredQuantity などの状態。`isDeleted` でソフト削除。
- **Receipt + ReceiptItem**: レシート本体と明細。`@Relationship(deleteRule: .cascade)` でレシート削除時に明細も削除。
- **PendingSync**: オフラインキュー用メタデータ。`retryCount` と `lastAttempt` を保持。

## 5. 同期処理（基本設計）
1. `SyncService.pull*`: Supabase から更新日時フィルタで取得 → `StockItem.upsert` などで SwiftData に反映 → `lastPull*` 更新。
2. `SyncService.push*`: ドメインモデルを DTO (`toDTO`) にマッピング → Supabase upsert/delete → 失敗時は `OfflineQueueService.queueSync`。
3. `OfflineQueueService`: `PendingSync` を作成/更新 → `processPendingSyncs` で順次処理 → 成功時 delete、失敗時 errorMessage + retryCount++。
4. `RootView` / `StockListView` / `ShoppingListView` などで `Task` を用い、認証・シーン遷移イベントをフックして `pullAll` や `processPendingSyncs` を呼び出す。

## 6. エラーハンドリング方針
- SwiftData 保存失敗時は `assertionFailure` とログ出力。
- Supabase 連携失敗は print ログ + OfflineQueue に退避。
- 最大 5 回リトライで打ち切り、`clearFailedSyncs` で手動削除可。

## 7. テスト計画（概要）
| テスト種別 | 内容 | ファイル |
| --- | --- | --- |
| モデル単体 | `StockItem` の初期化・SwiftData CRUD | `StockItemTests` |
| マッピング | DTO とモデルの相互変換 | `StockItemMappingTests` |
| サービス | `OfflineQueueService` の再送、リトライ | `OfflineQueueServiceTests` |
| View ロジック | 在庫/買い物の保存・同期挙動（暫定） | `StockListViewSyncTests` |
| UI テスト | タブ遷移、在庫追加、買い物操作 | `FamilyStockUITests` |

## 8. ログ・設定
- `Secrets.plist` に Supabase baseURL / anonKey を保持し、テンプレートからコピー。
- `AppStorage` で `lastPullItems`, `lastPullShopping`, `lastPullReceipts` を保持。
- 同期系ログは絵文字付き print で注視しやすくする。

## 9. 今後の設計検討ポイント
- `SyncService` のプロトコル化 (`SyncServiceProtocol`) によりテストダブル導入済み。実装をさらに DI し、View と疎結合にする。
- `StockListViewSyncTests` は View から切り出したロジックに差し替え予定。
- Push 通知や小部品共有を想定し、アクセシビリティ識別子 (`AddItem` など) を戦略的に付与済み。
