# 要件定義書

## 1. システム概要
FamilyStock は SwiftUI + SwiftData を基盤とした iOS アプリであり、Supabase（PostgREST + Auth）と連携して家庭内の在庫・買い物・レシート情報を同期する。オフライン利用を前提に `PendingSync` キューで変更をバッファし、オンライン復帰時に自動送信する。

## 2. ユースケース
1. **在庫登録**: ユーザーが「牛乳」を登録し、カテゴリや在庫量をセットする。
2. **在庫更新**: 賞味期限前の消費で数量を減らす。0 になれば買い物リストに追加。
3. **買い物リスト編集**: 自動追加されたエントリの数量・メモを編集し、完了チェックを付与。
4. **レシート保存**: 完了済みエントリをまとめてレシート化し、支出を記録。
5. **同期**: 手動操作時は即座に Supabase へ push、ネットワーク断時は `PendingSync` に蓄積。
6. **設定**: 認証、ローカルモード切り替え、同期状況確認。

## 3. 機能要件
### 3.1 在庫管理（Stock）
- CRUD 操作（作成・編集・アーカイブ）。
- `quantityInStock` と `quantityFullStock` の管理。
- 在庫 0 → `ShoppingListEntry` 自動追加。
- カテゴリ・ユーザー単位でのフィルタを今後追加できるようモデル構造を保持。

### 3.2 買い物リスト（Shopping）
- エントリ生成（自動/手動）。
- `desiredQuantity`, `unit`, `note`, `isCompleted`, `isDeleted` の状態遷移。
- 完了済みアイテムのレシート化支援。
- SwiftUI `ShoppingListRow` から数量変更／完了トグル。

### 3.3 レシート管理（Receipts）
- `Receipt` と `ReceiptItem` の新規作成。
- 完了済みショッピングエントリの再入庫（在庫量加算）。
- 金額（任意）、時刻の保持。

### 3.4 同期/オフライン
- `SyncService` による `pullItems/pullShopping/pullReceipts/push*`。
- Supabase API: fetchUpdatedSince、upsert、delete。
- `OfflineQueueService` が `PendingSync` を参照し、リトライ（最大 5 回）。
- `lastPull*` の ISO8601 文字列を AppStorage へ保持。

### 3.5 認証・設定
- Supabase Auth（`SupabaseClient.shared`）。
- ローカルモード時は pull/push を抑制し、UI 内のタスクで判定。

### 3.6 テスト
- ユニットテスト: `StockItemTests`, `StockItemMappingTests`, `OfflineQueueServiceTests`, `StockListViewSyncTests` 等。
- UI テスト: `FamilyStockUITests`（タブ遷移、在庫追加、買い物操作など）。

## 4. 非機能要件
| 項目 | 要件 |
| --- | --- |
| 対応 OS | iOS 17 以降（Simulator も同等） |
| パフォーマンス | 在庫 200 件でも 1 秒以内にリスト表示。同期リクエストは非同期。 |
| オフライン耐性 | 全 CRUD が SwiftData ローカルに書き込み可能。オンライン復帰時に自動同期。 |
| セキュリティ | Supabase Auth によるユーザー分離。Secrets.plist で API キー暗号化保管。 |
| 可観測性 | ログ（print）で pull/push 成功/失敗、リトライ回数を記録。 |
| テスト網羅 | 主要モデル/サービス/代表的 UI フローに対してテストを用意。 |

## 5. データ要件
| モデル | 主キー | 主な属性 |
| --- | --- | --- |
| `StockItem` | `id` (lowercased UUID) | `userId`, `name`, `category`, `updatedAt`, `isArchived`, `quantityInStock`, `quantityFullStock` |
| `ShoppingListEntry` | `id` (lowercased UUID) | `userId`, `itemId`, `desiredQuantity`, `unit`, `note`, `updatedAt`, `isDeleted`, `isCompleted` |
| `Receipt` | `id` | `userId`, `shopName`, `timestamp`, `amount`, `items` |
| `ReceiptItem` | `id` | `itemName`, `quantity`, `receipt` |
| `PendingSync` | `id` | `entityType`, `entityId`, `operation`, `createdAt`, `retryCount`, `lastAttempt`, `errorMessage` |

## 6. 外部インタフェース
- **Supabase REST**: `ItemRepository`, `ShoppingListEntryRepository`, `ReceiptRepository` が HTTP クライアント (`HTTPClient`) 経由で呼び出し。
- **認証**: `SupabaseClient.shared.currentUser?.id` を各モデルで保持し RLS に対応。
- **Secrets 管理**: `Secrets.plist` およびテンプレートで Base URL / anon key を定義。

## 7. 品質保証
- ユニットテストは Swift Testing フレームワーク (Xcode 15+) を採用。
- UI テストは XCTest UI API（`XCUIApplication`）で主要シナリオを自動化。
- オフライン制御や ID 正規化など、バグが出やすい箇所はピンポイントでテスト済み。

## 8. 今後の拡張要件（検討）
- 世帯共有（同一 `userId` グループ）でのリアルタイム更新。
- Push 通知による買い物リマインダー。
- レシート OCR / 画像添付。
これらを見据え、現行モデルは `userId` と履歴情報を保持している。
